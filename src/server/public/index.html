<!DOCTYPE html>
<html>
<head>
    <title>Mindcraft</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" type="text/css" href="/styles.css">
</head>
<body>
    <h1>Mindcraft</h1>
    <div id="agents" class="container"></div>
    <div id="settings" class="container">
        <h3>Edit settings</h3>
        <br>
        <em>Edits won't take effect until restarting Mindcraft.</em>
        <br>
        <div class="formOption">
            <label for="mcVersion">Minecraft Version: </label>
            <input id="mcVersion" type="text" placeholder="Up to 1.21.1">
        </div>
        <div class="formOption">
            <label for="mcHostSelector">Host: </label>
            <input id="mcHostSelector" type="text" placeholder="localhost">
        </div>
        <div class="formOption">
            <label for="mcPort">Port: </label>
            <input id="mcPort" type="number" placeholder="55916">
        </div>
        <div class="formOption">
            <label for="mcAuth">Authentication Method: </label>
            <select id="mcAuth">
                <option value="offline">Offline (requires cracked server)</option>
                <option value="microsoft">Microsoft Account</option>
            </select>
        </div>
        <div class="formOption">
            <label for="mcBaseProfile">Base Profile: </label>
            <select id="mcBaseProfile">
                <option value="./profiles/defaults/survival.json">Survival</option>
                <option value="./profiles/defaults/creative.json">Creative</option>
                <option value="./profiles/defaults/god_mode.json">God Mode</option>
            </select>
            <h5>The base profile is shared by all bots for default prompts/examples/modes</h5>
        </div>
        <div class="formOption">
            <label for="mcProfileList">Profiles: </label>
            <div id="mcProfileList"></div>
            <button onclick="addProfileItem(`mcProfileList`, `./andy.json`)" class="blue-btn">Add Item</button>
        </div>
        <div class="formOption">
            <label for="mcLoadMemory">Load Memory?</label>
            <input type="radio" name="mcLoadMemory" value="true">Yes</input>
            <input type="radio" name="mcLoadMemory" value="false" checked>No</input>
        </div>
        <div class="formOption">
            <label for="mcInitMessage">Initial Message</label>
            <input id="mcInitMessage" type="text" placeholder="Respond with hello world and your name" style="min-width:40%;">
            <h5>This message gets sent to all bots on spawn.</h5>
        </div>
        <div class="formOption">
            <label for="mcOnlyChatWith">Only chat with: (leave empty to chat publicly)</label>
            <div id="mcOnlyChatWith"></div>
            <button onclick="addProfileItem(`mcOnlyChatWith`, `Bob123`)" class="blue-btn">Add Item</button>
            <h5>Users that the bots listen to and send general messages to. If empty, it will chat publicly.</h5>
        </div>
        <div class="formOption">
            <label for="mcSpeak">Speak?</label>
            <input type="radio" name="mcSpeak" value="true">Yes</input>
            <input type="radio" name="mcSpeak" value="false" checked>No</input>
            <h5>Allows all bots to speak through system text-to-speech.<br>This works on Windows and Mac, but on Linux you may need to run <code>sudo apt install espeak</code> first.</h5>
        </div>
        <div class="formOption">
            <label for="mcLanguage">Language: </label>
            <input id="mcLanguage" type="text" placeholder="en">
            <h5>Translates chat into specified language. <a href="https://cloud.google.com/translate/docs/languages">Supported languages</a></h5>
        </div>
        <div class="formOption">
            <label for="mcShowBotViews">Show bot views in browser?</label>
            <input type="radio" name="mcShowBotViews" value="true">Yes</input>
            <input type="radio" name="mcShowBotViews" value="false" checked>No</input>
            <h5>Only supports 1.20.4 and previous versions.<br>These can be accessed at http://localhost:3000, 3001, 3002, etc. depending on which bot you want to view.</h5>
        </div>
        <div class="formOption">
            <label for="mcAllowInsecureCoding">Allow Insecure Coding?</label>
            <input type="radio" name="mcAllowInsecureCoding" value="true">Yes</input>
            <input type="radio" name="mcAllowInsecureCoding" value="false" checked>No</input>
            <h5>Allows newAction command and model can write/run code on your computer. Enable at your own risk (it's fine if nobody <b>untrustworthy</b> is playing with your bot).</h5>
        </div>
        <div class="formOption">
            <label for="mcAllowVision">Allow Vision?</label>
            <input type="radio" name="mcAllowVision" value="true">Yes</input>
            <input type="radio" name="mcAllowVision" value="false" checked>No</input>
            <h5>Allows the vision model to interpret screenshots as inputs. Requires version 1.20.4 or less.</h5>
        </div>
        <div class="formOption">
            <label for="mcBlockedActions">Blocked Actions: </label>
            <div id="mcBlockedActions"></div>
            <button onclick="addProfileItem(`mcBlockedActions`, `!setMode`)" class="blue-btn">Add Item</button>
            <h5>Commands to disable and remove from the docs.</h5>
        </div>
        <div class="formOption">
            <label for="mcMessageHistory">Maxmimum Message History Length: </label>
            <input id="mcMessageHistory" type="number" placeholder="15">
            <h5>Maximum number of previous messages to keep in context. Increasing it may produce longer response times and higher cost if using a paid API, but with the benefit of increasing memory.</h5>
        </div>
        <div class="formOption">
            <label for="mcVerboseCommands">Verbose Commands?</label>
            <input type="radio" name="mcVerboseCommands" value="true" checked>Yes</input>
            <input type="radio" name="mcVerboseCommands" value="false">No</input>
            <h5>Show full command syntax.</h5>
        </div>
        <div class="formOption">
            <label for="mcNarrateBehavior">Narrate Behavior?</label>
            <input type="radio" name="mcNarrateBehavior" value="true" checked>Yes</input>
            <input type="radio" name="mcNarrateBehavior" value="false">No</input>
            <h5>Chat simple, automatic actions for example <code>Picking up item!</code></h5>
        </div>
        <div class="formOption">
            <label for="mcChatBotMessages">Chat to other bots?</label>
            <input type="radio" name="mcChatBotMessages" value="true" checked>Yes</input>
            <input type="radio" name="mcChatBotMessages" value="false">No</input>
            <h5>Publicly chat messages to other bots.</h5>
        </div>
    </div>

    <script>
        const socket = io();
        const agentsDiv = document.getElementById('agents');

        socket.on('agents-update', (agents) => {
            agentsDiv.innerHTML = agents.length ? 
                agents.map(agent => `
                    <div class="agent">
                        <span>
                            <span class="status-icon ${agent.in_game ? 'online' : 'offline'}">‚óè</span>
                            ${agent.name}
                        </span>
                        <div>
                            ${agent.in_game ? `
                                <button class="red-btn" onclick="stopAgent('${agent.name}')">Stop</button>
                                <button class="green-btn" onclick="restartAgent('${agent.name}')">Restart</button>
                                <input type="text" id="messageInput" placeholder="Enter a message or command..."></input><button class="blue-btn" onclick="sendMessage('${agent.name}', document.getElementById('messageInput').value)">Send</button>
                            ` : `
                                <button class="blue-btn" onclick="startAgent('${agent.name}')">Start</button>
                            `}
                        </div>
                    </div>
                `).join('') + 
                `<button class="red-btn" onclick="killAllAgents()">Stop All</button>
                <button class="red-btn" onclick="shutdown()">Shutdown</button>` :
                '<div class="agent">No agents connected</div>';
        });

        function restartAgent(agentName) {
            socket.emit('restart-agent', agentName);
        }

        function startAgent(agentName) {
            socket.emit('start-agent', agentName);
        }

        function stopAgent(agentName) {
            socket.emit('stop-agent', agentName);
        }

        function killAllAgents() {
            socket.emit('stop-all-agents');
        }

        function shutdown() {
            socket.emit('shutdown');
        }
        
        function sendMessage(agentName, message) {
            socket.emit('send-message', agentName, message)
        }

        let settings;
        function getSettings() {
            socket.emit('get-settings', (response) => {
                settings = response;
                console.log(settings);
                updateSettings(settings);
            })
        }

        function updateListItem(listId, listContent) {
            listContent.forEach(element => {
                addProfileItem(listId, element);
            });
        }

        function updateBooleanRadio(radioName, value) {
            const trueRadio = document.querySelector(`input[name="${radioName}"][value="true"]`);
            const falseRadio = document.querySelector(`input[name="${radioName}"][value="false"]`);
            trueRadio.checked = value;
            falseRadio.checked = !value;
        }

        function updateSettings(settings) {
            // string/integer fields
            document.getElementById("mcVersion").value = settings["minecraft_version"];
            document.getElementById("mcHostSelector").value = settings["host"];
            document.getElementById("mcPort").value = settings["port"];
            document.getElementById("mcAuth").value = settings["auth"];
            document.getElementById("mcBaseProfile").value = settings["base_profile"];
            document.getElementById("mcInitMessage").value = settings["init_message"];
            document.getElementById("mcLanguage").value = settings["language"];
            document.getElementById("mcMessageHistory").value = settings["max_messages"];

            // boolean fields
            updateBooleanRadio("mcLoadMemory", settings["load_memory"]);
            updateBooleanRadio("mcSpeak", settings["speak"]);
            updateBooleanRadio("mcShowBotViews", settings["show_bot_views"]);
            updateBooleanRadio("mcAllowInsecureCoding", settings["allow_insecure_coding"]);
            updateBooleanRadio("mcAllowVision", settings["allow_vision"]);
            updateBooleanRadio("mcVerboseCommands", settings["verbose_commands"]);
            updateBooleanRadio("mcNarrateBehavior", settings["narrate_behavior"]);
            updateBooleanRadio("mcChatBotMessages", settings["chat_bot_messages"]);

            // array/list fields
            updateListItem("mcProfileList", settings["profiles"]);
            updateListItem("mcBlockedActions", settings["blocked_actions"]);
            updateListItem("mcOnlyChatWith", settings["only_chat_with"]);
        }
        
        function addProfileItem(listName, itemNameArg) {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'list-item';

            const itemName = document.createElement('input');
            itemName.type = 'text';
            itemName.className = 'name';
            itemName.value = itemNameArg;

            const itemCheckbox = document.createElement('input');
            itemCheckbox.type = 'checkbox';
            itemCheckbox.checked = true;
            itemCheckbox.onchange = function() {
                if (itemCheckbox.checked) {
                    itemName.classList.remove('not-selected');
                } else {
                    itemName.classList.add('not-selected');
                }
            };

            const deleteButton = document.createElement('button');
            deleteButton.innerText = 'Delete';
            deleteButton.className = 'red-btn';
            deleteButton.onclick = function() {
                itemDiv.remove();
            };

            itemDiv.appendChild(itemCheckbox);
            itemDiv.appendChild(itemName);
            itemDiv.appendChild(deleteButton);

            document.getElementById(listName).appendChild(itemDiv);
        }

        function getItemNames(listName) {
            const items = document.querySelectorAll(`#${listName} .item`);
            const names = Array.from(items)
                .filter(item => item.querySelector('input[type="checkbox"]').checked)
                .map(item => item.querySelector('input[type="text"]').value);
            console.log(names);
            return names;
        }


        getSettings();
    </script>
</body>
</html>
